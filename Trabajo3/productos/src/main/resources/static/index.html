<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>CRUD Productos - XML</title>
    <style>
        body{font-family:Arial;padding:12px}
        input,textarea{display:block;margin-bottom:6px}
        table{border-collapse:collapse;margin-top:10px}
        th,td{padding:6px;border:1px solid #999}
        button{margin-right:4px}
    </style>
</head>
<body>

<h2>Productos (CRUD con XML)</h2>

<form id="form">
    <input id="id" type="hidden" />
    <label>Nombre</label><input id="nombre" required />
    <label>Descripci√≥n</label><input id="descripcion" />
    <label>Categor√≠a</label><input id="categoria" />
    <label>Valor</label><input id="valor" type="number" step="0.01" required />
    <label>Stock</label><input id="stock" type="number" required />
    <button>Guardar</button>
</form>

<h3>Listado</h3>
<input id="buscar" placeholder="Buscar nombre" />
<button id="btnBuscar">Buscar</button>

<table id="tabla">
    <thead>
    <tr>
        <th>ID</th><th>Nombre</th><th>Categor√≠a</th><th>Valor</th><th>Stock</th><th>Acc</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<hr>

<h3>Informe XML</h3>
<button id="btnXml">Ver XML</button>
<button id="btnDescargar">Descargar XML</button>

<pre id="xmlViewer" style="background:#eee;padding:10px;white-space:pre-wrap;">
(Presione "Ver XML")
</pre>

<script>
    const api = "https://distribuidaparalela.onrender.com/api/productos";

    // ------------------------------------
    // Convertir producto ‚Üí XML
    // ------------------------------------
    function productoToXML(prod) {
        return `
            <producto>
                ${prod.id ? `<id>${prod.id}</id>` : ""}
                <nombre>${prod.nombre}</nombre>
                <descripcion>${prod.descripcion}</descripcion>
                <categoria>${prod.categoria}</categoria>
                <valor>${prod.valor}</valor>
                <stock>${prod.stock}</stock>
            </producto>
        `.trim();
    }

    // ------------------------------------
    // Listar (se mantiene en JSON por simplicidad)
    // ------------------------------------
    async function listar(q="") {
        let url = api;
        if(q) url += "?q=" + encodeURIComponent(q);

        const r = await fetch(url, { headers:{ "Accept":"application/json" } });
        const data = await r.json();

        const tbody = document.querySelector("#tabla tbody");
        tbody.innerHTML = "";

        data.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.categoria}</td>
                    <td>${p.valor}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button onclick="editar(${p.id})">Editar</button>
                        <button onclick="eliminar(${p.id})">X</button>
                    </td>
                </tr>
            `;
        });
    }

    // ------------------------------------
    // Guardar / Editar (POST y PUT en XML)
    // ------------------------------------
    document.getElementById("form").addEventListener("submit", async e => {
        e.preventDefault();

        const prod = {
            id: document.getElementById("id").value || null,
            nombre: document.getElementById("nombre").value,
            descripcion: document.getElementById("descripcion").value,
            categoria: document.getElementById("categoria").value,
            valor: parseFloat(document.getElementById("valor").value),
            stock: parseInt(document.getElementById("stock").value)
        };

        const xmlBody = productoToXML(prod);

        await fetch(prod.id ? `${api}/${prod.id}` : api, {
            method: prod.id ? "PUT" : "POST",
            headers: {
                "Content-Type": "application/xml",
                "Accept": "application/xml"
            },
            body: xmlBody
        });

        e.target.reset();
        document.getElementById("id").value = "";
        listar();
    });

    // ------------------------------------
    // Cargar producto para edici√≥n (GET XML)
    // ------------------------------------
    async function editar(id) {
        const r = await fetch(`${api}/${id}`, { headers:{ "Accept":"application/xml" } });
        const xml = await r.text();

        const x = new DOMParser().parseFromString(xml, "application/xml");

        document.getElementById("id").value        = x.getElementsByTagName("id")[0].textContent;
        document.getElementById("nombre").value    = x.getElementsByTagName("nombre")[0].textContent;
        document.getElementById("descripcion").value = x.getElementsByTagName("descripcion")[0].textContent;
        document.getElementById("categoria").value = x.getElementsByTagName("categoria")[0].textContent;
        document.getElementById("valor").value     = x.getElementsByTagName("valor")[0].textContent;
        document.getElementById("stock").value     = x.getElementsByTagName("stock")[0].textContent;
    }

    // ------------------------------------
    // Eliminar
    // ------------------------------------
    async function eliminar(id) {
        await fetch(`${api}/${id}`, { method:"DELETE" });
        listar();
    }

    // Buscar
    document.getElementById("btnBuscar").onclick = () => {
        listar(document.getElementById("buscar").value);
    };

    // üîπ XML ‚Üí mostrar √°rbol
    function xmlToTree(xml, container) {
        container.innerHTML = "";
        function createNode(node){
            let li = document.createElement("li");
            if(node.nodeType === 1){
                let text = node.nodeName;
                if(node.attributes.length>0){
                    let attrs = [];
                    for(let i=0;i<node.attributes.length;i++){
                        attrs.push(node.attributes[i].name+'="'+node.attributes[i].value+'"');
                    }
                    text += " [" + attrs.join(", ") + "]";
                }
                li.textContent = text;
                let children = node.childNodes;
                if(children.length>0){
                    let ul = document.createElement("ul");
                    for(let i=0;i<children.length;i++){
                        ul.appendChild(createNode(children[i]));
                    }
                    li.appendChild(ul);
                }
            } else if(node.nodeType===3){
                let t = node.nodeValue.trim();
                if(t) li.textContent += ": "+t;
            }
            return li;
        }
        let ul = document.createElement("ul");
        ul.appendChild(createNode(xml.documentElement));
        container.appendChild(ul);
    }

    // üîπ Bot√≥n ver XML
    document.getElementById("btnVerXml").onclick = async () => {
        const r = await fetch(api+'/reporte/xml', { headers: {"Accept": "application/xml"} });
        const xmlText = await r.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        // √Årbol
        const container = document.getElementById("xmlTree");
        xmlToTree(xmlDoc, container);

        // Resumen
        const total = xmlDoc.getElementsByTagName("total_valor")[0].textContent;
        document.getElementById("resumen").innerHTML = `<b>Total de productos:</b> ${total}`;
    };

    // üîπ Bot√≥n descargar XML
    document.getElementById("btnDownloadXml").onclick = async () => {
        const r = await fetch(api+'/reporte/xml', { headers: {"Accept": "application/xml"} });
        const xmlText = await r.text();
        const blob = new Blob([xmlText], { type: 'application/xml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "productos.xml";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    };

    listar();
</script>

</body>
</html>