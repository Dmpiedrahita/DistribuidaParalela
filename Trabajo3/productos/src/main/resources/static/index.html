<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>CRUD Productos - XML</title>
    <style>
        body{font-family:Arial;padding:12px}
        input,textarea{display:block;margin-bottom:6px}
        table{border-collapse:collapse;margin-top:10px}
        th,td{padding:6px;border:1px solid #999}
        button{margin-right:4px}
        #xmlTree ul{list-style-type:none;padding-left:20px}
        #xmlTree li{margin:2px 0}
    </style>
</head>
<body>

<h2>Productos (CRUD con XML)</h2>

<form id="form">
    <input id="id" type="hidden" />
    <label>Nombre</label><input id="nombre" required />
    <label>Descripción</label><input id="descripcion" />
    <label>Categoría</label><input id="categoria" />
    <label>Valor</label><input id="valor" type="number" step="0.01" required />
    <label>Stock</label><input id="stock" type="number" required />
    <button>Guardar</button>
</form>

<h3>Listado</h3>
<input id="buscar" placeholder="Buscar nombre" />
<button id="btnBuscar">Buscar</button>

<table id="tabla">
    <thead>
    <tr>
        <th>ID</th><th>Nombre</th><th>Categoría</th><th>Valor</th><th>Stock</th><th>Acc</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<hr>

<h3>Informe XML</h3>
<button id="btnXml">Ver XML</button>
<button id="btnDescargar">Descargar XML</button>

<div id="resumen"></div>
<div id="xmlTree" style="border:1px solid #ccc; padding:10px; max-height:400px; overflow:auto;">
    (Presione "Ver XML")
</div>

<pre id="xmlViewer" style="background:#eee;padding:10px;white-space:pre-wrap;">
(Presione "Ver XML")
</pre>

<script>
    const api = "https://distribuidaparalela.onrender.com/api/productos";

    // Convertir producto → XML
    function productoToXML(prod) {
        return `
        <producto>
            ${prod.id ? `<id>${prod.id}</id>` : ""}
            <nombre>${prod.nombre}</nombre>
            <descripcion>${prod.descripcion}</descripcion>
            <categoria>${prod.categoria}</categoria>
            <valor>${prod.valor}</valor>
            <stock>${prod.stock}</stock>
        </producto>
    `.trim();
    }

    // Listar productos
    async function listar(q="") {
        const url = q ? `${api}?q=${encodeURIComponent(q)}` : api;
        const r = await fetch(url, { headers:{ "Accept":"application/json" } });
        const data = await r.json();
        const tbody = document.querySelector("#tabla tbody");
        tbody.innerHTML = "";
        data.forEach(p => {
            tbody.innerHTML += `
            <tr>
                <td>${p.id}</td>
                <td>${p.nombre}</td>
                <td>${p.categoria}</td>
                <td>${p.valor}</td>
                <td>${p.stock}</td>
                <td>
                    <button onclick="editar(${p.id})">Editar</button>
                    <button onclick="eliminar(${p.id})">X</button>
                </td>
            </tr>
        `;
        });
    }

    // Guardar / Editar
    document.getElementById("form")?.addEventListener("submit", async e => {
        e.preventDefault();
        const prod = {
            id: document.getElementById("id")?.value || null,
            nombre: document.getElementById("nombre")?.value,
            descripcion: document.getElementById("descripcion")?.value,
            categoria: document.getElementById("categoria")?.value,
            valor: parseFloat(document.getElementById("valor")?.value),
            stock: parseInt(document.getElementById("stock")?.value)
        };
        const xmlBody = productoToXML(prod);
        await fetch(prod.id ? `${api}/${prod.id}` : api, {
            method: prod.id ? "PUT" : "POST",
            headers: { "Content-Type": "application/xml", "Accept": "application/xml" },
            body: xmlBody
        });
        e.target.reset();
        if(document.getElementById("id")) document.getElementById("id").value = "";
        listar();
    });

    // Editar
    async function editar(id) {
        const r = await fetch(`${api}/${id}`, { headers:{ "Accept":"application/xml" } });
        const xml = await r.text();
        const x = new DOMParser().parseFromString(xml, "application/xml");

        ["id","nombre","descripcion","categoria","valor","stock"].forEach(tag => {
            const el = document.getElementById(tag);
            const node = x.getElementsByTagName(tag)[0];
            if(el && node) el.value = node.textContent;
        });
    }

    // Eliminar
    async function eliminar(id) {
        await fetch(`${api}/${id}`, { method:"DELETE" });
        listar();
    }

    // Buscar
    document.getElementById("btnBuscar")?.addEventListener("click", () => {
        listar(document.getElementById("buscar")?.value || "");
    });

    // Convertir XML → árbol
    function xmlToTree(xml, container) {
        if(!container) return;
        container.innerHTML = "";
        function createNode(node){
            let li = document.createElement("li");
            if(node.nodeType === 1){
                let text = node.nodeName;
                if(node.attributes.length>0){
                    let attrs = Array.from(node.attributes).map(a => `${a.name}="${a.value}"`);
                    text += " [" + attrs.join(", ") + "]";
                }
                li.textContent = text;
                const children = node.childNodes;
                if(children.length>0){
                    let ul = document.createElement("ul");
                    for(let i=0;i<children.length;i++) ul.appendChild(createNode(children[i]));
                    li.appendChild(ul);
                }
            } else if(node.nodeType===3){
                const t = node.nodeValue.trim();
                if(t) li.textContent += ": "+t;
            }
            return li;
        }
        const ul = document.createElement("ul");
        ul.appendChild(createNode(xml.documentElement));
        container.appendChild(ul);
    }

    // Ver XML
    document.getElementById("btnXml")?.addEventListener("click", async () => {
        const r = await fetch(`${api}/reporte/xml`, { headers:{ "Accept":"application/xml" } });
        const xmlText = await r.text();

        const xmlViewer = document.getElementById("xmlViewer");
        if(xmlViewer) xmlViewer.textContent = xmlText;

        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");

        xmlToTree(xmlDoc, document.getElementById("xmlTree"));

        const totalNode = xmlDoc.getElementsByTagName("total_valor")[0];
        const resumen = document.getElementById("resumen");
        if(resumen) resumen.innerHTML = `<b>Total de productos:</b> ${totalNode ? totalNode.textContent : '0'}`;
    });

    // Descargar XML
    document.getElementById("btnDescargar")?.addEventListener("click", async () => {
        const r = await fetch(`${api}/reporte/xml`);
        const xmlText = await r.text();
        const blob = new Blob([xmlText], { type:"application/xml" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "reporte_productos.xml";
        a.click();
        URL.revokeObjectURL(url);
    });

    listar();
</script>

</body>
</html>
