<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>CRUD Productos - XML</title>
    <style>
        body{font-family:Arial;padding:12px}
        input,textarea{display:block;margin-bottom:6px}
        table{border-collapse:collapse;margin-top:10px}
        th,td{padding:6px;border:1px solid #999}
        button{margin-right:4px}
    </style>
</head>
<body>

<h2>Productos (CRUD con XML)</h2>

<form id="form">
    <input id="id" type="hidden" />
    <label>Nombre</label><input id="nombre" required />
    <label>Descripción</label><input id="descripcion" />
    <label>Categoría</label><input id="categoria" />
    <label>Valor</label><input id="valor" type="number" step="0.01" required />
    <label>Stock</label><input id="stock" type="number" required />
    <button>Guardar</button>
</form>

<h3>Listado</h3>
<input id="buscar" placeholder="Buscar nombre" />
<button id="btnBuscar">Buscar</button>

<table id="tabla">
    <thead>
    <tr>
        <th>ID</th><th>Nombre</th><th>Categoría</th><th>Valor</th><th>Stock</th><th>Acc</th>
    </tr>
    </thead>
    <tbody></tbody>
</table>

<hr>

<h3>Informe XML</h3>
<button id="btnXml">Ver XML</button>
<button id="btnDescargar">Descargar XML</button>

<pre id="xmlViewer" style="background:#eee;padding:10px;white-space:pre-wrap;">
(Presione "Ver XML")
</pre>

<script>
    const api = "https://distribuidaparalela.onrender.com/api/productos";

    // ------------------------------------
    // Convertir producto → XML
    // ------------------------------------
    function productoToXML(prod) {
        return `
            <producto>
                ${prod.id ? `<id>${prod.id}</id>` : ""}
                <nombre>${prod.nombre}</nombre>
                <descripcion>${prod.descripcion}</descripcion>
                <categoria>${prod.categoria}</categoria>
                <valor>${prod.valor}</valor>
                <stock>${prod.stock}</stock>
            </producto>
        `.trim();
    }

    // ------------------------------------
    // Listar (se mantiene en JSON por simplicidad)
    // ------------------------------------
    async function listar(q="") {
        let url = api;
        if(q) url += "?q=" + encodeURIComponent(q);

        const r = await fetch(url, { headers:{ "Accept":"application/json" } });
        const data = await r.json();

        const tbody = document.querySelector("#tabla tbody");
        tbody.innerHTML = "";

        data.forEach(p => {
            tbody.innerHTML += `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.nombre}</td>
                    <td>${p.categoria}</td>
                    <td>${p.valor}</td>
                    <td>${p.stock}</td>
                    <td>
                        <button onclick="editar(${p.id})">Editar</button>
                        <button onclick="eliminar(${p.id})">X</button>
                    </td>
                </tr>
            `;
        });
    }

    // ------------------------------------
    // Guardar / Editar (POST y PUT en XML)
    // ------------------------------------
    document.getElementById("form").addEventListener("submit", async e => {
        e.preventDefault();

        const prod = {
            id: document.getElementById("id").value || null,
            nombre: document.getElementById("nombre").value,
            descripcion: document.getElementById("descripcion").value,
            categoria: document.getElementById("categoria").value,
            valor: parseFloat(document.getElementById("valor").value),
            stock: parseInt(document.getElementById("stock").value)
        };

        const xmlBody = productoToXML(prod);

        await fetch(prod.id ? `${api}/${prod.id}` : api, {
            method: prod.id ? "PUT" : "POST",
            headers: {
                "Content-Type": "application/xml",
                "Accept": "application/xml"
            },
            body: xmlBody
        });

        e.target.reset();
        document.getElementById("id").value = "";
        listar();
    });

    // ------------------------------------
    // Cargar producto para edición (GET XML)
    // ------------------------------------
    async function editar(id) {
        const r = await fetch(`${api}/${id}`, { headers:{ "Accept":"application/xml" } });
        const xml = await r.text();

        const x = new DOMParser().parseFromString(xml, "application/xml");

        document.getElementById("id").value        = x.getElementsByTagName("id")[0].textContent;
        document.getElementById("nombre").value    = x.getElementsByTagName("nombre")[0].textContent;
        document.getElementById("descripcion").value = x.getElementsByTagName("descripcion")[0].textContent;
        document.getElementById("categoria").value = x.getElementsByTagName("categoria")[0].textContent;
        document.getElementById("valor").value     = x.getElementsByTagName("valor")[0].textContent;
        document.getElementById("stock").value     = x.getElementsByTagName("stock")[0].textContent;
    }

    // ------------------------------------
    // Eliminar
    // ------------------------------------
    async function eliminar(id) {
        await fetch(`${api}/${id}`, { method:"DELETE" });
        listar();
    }

    // Buscar
    document.getElementById("btnBuscar").onclick = () => {
        listar(document.getElementById("buscar").value);
    };

    // ------------------------------------
    // Ver XML del reporte
    // ------------------------------------
    document.getElementById("btnXml").onclick = async () => {
        const r = await fetch(`${api}/reporte/xml`, {
            headers: { "Accept":"application/xml" }
        });
        const xml = await r.text();
        document.getElementById("xmlViewer").textContent = xml;
    };

    // ------------------------------------
    // Descargar XML
    // ------------------------------------
    document.getElementById("btnDescargar").onclick = async () => {
        const r = await fetch(`${api}/reporte/xml`);
        const xml = await r.text();

        const blob = new Blob([xml], { type: "application/xml" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "reporte_productos.xml";
        a.click();
    };

    listar();
</script>

</body>
</html>
